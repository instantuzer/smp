#!/usr/bin/env bash

# -------- MICROPHONE CHECK (PipeWire) --------
mic_active="no"

if command -v wpctl >/dev/null 2>&1; then
    # Check if any source is RUNNING
    if pw-cli ls Node 2>/dev/null | grep -B5 "media.class = Audio/Source" | grep -q "state.*running"; then
        mic_active="yes"
    fi
fi

# -------- CAMERA CHECK --------
cam_active="no"

# Check if any process is using /dev/video*
for dev in /dev/video*; do
    if [ -e "$dev" ]; then
        if fuser "$dev" >/dev/null 2>&1; then
            cam_active="yes"
            break
        fi
    fi
done

# -------- ICON + MESSAGE --------
if [[ "$mic_active" == "yes" && "$cam_active" == "yes" ]]; then
    dunstify -u critical "ðŸŽ¤ðŸ“· Recording Active" "Microphone and Camera are in use"
elif [[ "$mic_active" == "yes" ]]; then
    dunstify -u critical "ðŸŽ¤ Microphone Active" "Microphone is currently recording"
elif [[ "$cam_active" == "yes" ]]; then
    dunstify -u critical "ðŸ“· Camera Active" "Camera is currently in use"
else
    dunstify -u low "AV Status" "No active microphone or camera usage"
fi
