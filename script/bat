#!/bin/bash

BAT=$(ls /sys/class/power_supply/ | grep -E 'BAT' | head -n 1)
if [[ -z "$BAT" ]]; then exit 0; fi

BAT="/sys/class/power_supply/BAT0"

LOW_ID=9999
DISCHARGE_ID=8888

REMIND_INTERVAL=600   # 10 minutes in seconds

last_discharge_notify=0
was_discharging=0

while true; do
    PERC=$(cat "$BAT/capacity")
    STATUS=$(cat "$BAT/status")
    now=$(date +%s)

    # -----------------------------
    # DISCHARGING REMINDER LOGIC
    # -----------------------------
    if [[ "$STATUS" == "Discharging" ]]; then
        if [[ $was_discharging -eq 0 ]]; then
            # Just started discharging → notify immediately
            dunstify -u normal -r $DISCHARGE_ID \
                "Discharging" "at ${PERC}%"

            last_discharge_notify=$now
            was_discharging=1
        elif (( now - last_discharge_notify >= REMIND_INTERVAL )); then
            # 10 minutes passed → remind
            dunstify -u normal -r $DISCHARGE_ID \
                "Discharging" "at ${PERC}%"

            last_discharge_notify=$now
        fi
    else
        # Charging or Full → reset state and close notification
        dunstctl close $DISCHARGE_ID
        was_discharging=0
    fi

    # -----------------------------
    # LOW BATTERY LOGIC (unchanged)
    # -----------------------------
    if [[ "$PERC" -lt 20 && "$STATUS" == "Discharging" ]]; then
        dunstify -u critical -r $LOW_ID \
            "Low" "at ${PERC}%"
    else
        dunstctl close $LOW_ID
    fi

    if [[ $PERC -lt 10 && "$STATUS" == "Discharging" ]]; then
        dunstify -u critical "Critical" "suspending in 20 sec BAT (${PERC}%)"

        for i in {1..20}; do
        sleep 1

        # Refresh battery status
        STATUS=$(cat /sys/class/power_supply/BAT0/status)

        # If plugged in, cancel suspend
        if [[ "$STATUS" != "Discharging" ]]; then
            dunstify "Suspend cancelled" "charging..."
            exit 0
        fi
    done

    # Double-check before suspending
    STATUS=$(cat /sys/class/power_supply/BAT0/status)
    if [[ "$STATUS" == "Discharging" ]]; then
        systemctl suspend
    fi

    fi

    sleep 5
done

