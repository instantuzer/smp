#!/usr/bin/env bash

ACTION="$1"

notify() {
    # $1 = message
    if command -v dunstify >/dev/null 2>&1; then
        dunstify "Device Status" "$1"
    else
        echo "$1"
    fi
}

print_status() {
    echo "=== Microphone Status ==="

    if command -v wpctl >/dev/null 2>&1; then
        # PipeWire
        if wpctl get-volume @DEFAULT_SOURCE@ | grep -q MUTED; then
            echo "Microphone is muted"
        else
            echo "Microphone is active (not muted)"
        fi
    else
        # PulseAudio fallback
        if pactl get-source-mute @DEFAULT_SOURCE@ | grep -q "yes"; then
            echo "Microphone is muted"
        else
            echo "Microphone is active (not muted)"
        fi
    fi

    echo ""
    echo "=== Camera Status ==="

    if lsmod | grep -qE "uvcvideo"; then
        echo "Camera driver (uvcvideo) loaded â†’ Camera likely enabled"
    elif ls /dev/video* >/dev/null 2>&1; then
        echo "Video device detected (driver may be unloaded)"
    else
        echo "No camera device detected"
    fi
}

mic_on() {
    if command -v wpctl >/dev/null 2>&1; then
        wpctl set-mute @DEFAULT_SOURCE@ 0
    else
        pactl set-source-mute @DEFAULT_SOURCE@ 0
    fi
    notify "Microphone unmuted"
}

mic_off() {
    if command -v wpctl >/dev/null 2>&1; then
        wpctl set-mute @DEFAULT_SOURCE@ 1
    else
        pactl set-source-mute @DEFAULT_SOURCE@ 1
    fi
    notify "Microphone muted"
}

mic_toggle() {
    if command -v wpctl >/dev/null 2>&1; then
        CURRENT=$(wpctl get-volume @DEFAULT_SOURCE@ | grep -q MUTED && echo "muted" || echo "active")
    else
        CURRENT=$(pactl get-source-mute @DEFAULT_SOURCE@ | grep -q "yes" && echo "muted" || echo "active")
    fi

    if [[ "$CURRENT" == "muted" ]]; then
        mic_on
    else
        mic_off
    fi
}

cam_on() {
    if sudo modprobe uvcvideo; then
        notify "Camera enabled"
    else
        notify "Failed to enable camera"
    fi
}

cam_off() {
    if sudo modprobe -r uvcvideo; then
        notify "Camera disabled"
    else
        notify "Failed to disable camera (may be in use)"
    fi
}

cam_toggle() {
    if lsmod | grep -qE "uvcvideo"; then
        cam_off
    else
        cam_on
    fi
}

case "$ACTION" in
    status|"")
        print_status
        ;;
    mic-on)
        mic_on
        ;;
    mic-off)
        mic_off
        ;;
    mic-toggle)
        mic_toggle
        ;;
    cam-on)
        cam_on
        ;;
    cam-off)
        cam_off
        ;;
    cam-toggle)
        cam_toggle
        ;;
    *)
        echo "Usage:"
        echo "  $0 status"
        echo "  $0 mic-on | mic-off | mic-toggle"
        echo "  $0 cam-on | cam-off | cam-toggle"
        ;;
esac
